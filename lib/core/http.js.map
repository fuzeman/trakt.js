{"version":3,"sources":["core/http.js"],"names":["HttpClient","client","baseUrl","_client","_baseUrl","path","options","request","method","headers","params","body","bodyType","authenticated","session","application","includeAppParameters","key","getSession","then","Promise","reject","Error","error","message","access_token","name","version","build","date","_buildUserAgent","JSON","stringify","debug","console","fetch","encodeParameters","response","json","parameters","Object","keys","forEach","encode","result","fragments","filter","fragment","length","join"],"mappings":"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","file":"core/http.js","sourcesContent":["import {isDefined} from './helpers';\r\n\r\nimport merge from 'lodash-amd/merge';\r\nimport querystring from 'querystring';\r\n\r\nexport default class HttpClient {\r\n    constructor(client, baseUrl) {\r\n        this._client = client;\r\n        this._baseUrl = baseUrl || 'https://api.trakt.tv/';\r\n    }\r\n\r\n    get baseUrl() {\r\n        return this._baseUrl;\r\n    }\r\n\r\n    get(path, options) {\r\n        return this.request('GET', path, options);\r\n    }\r\n\r\n    post(path, options) {\r\n        return this.request('POST', path, options);\r\n    }\r\n\r\n    request(method, path, options) {\r\n        options = merge({\r\n            headers: {},\r\n            params: {},\r\n\r\n            // Body\r\n            body: null,\r\n            bodyType: 'json',\r\n\r\n            // Authentication\r\n            authenticated: false,\r\n            session: null,\r\n\r\n            // Application\r\n            application: null,\r\n            includeAppParameters: false\r\n        }, options || {});\r\n\r\n        if(!isDefined(options.application)) {\r\n            options.application = this._client.application;\r\n        }\r\n\r\n        // Set request headers\r\n        options.headers['trakt-api-key'] = this._client.key;\r\n        options.headers['trakt-api-version'] = 2;\r\n\r\n        // Authentication\r\n        if(options.authenticated) {\r\n            if(!isDefined(options.session)) {\r\n                // Retrieve current client session\r\n                return this._client.getSession().then((session) => {\r\n                    if(!isDefined(session)) {\r\n                        // Invalid session returned\r\n                        return Promise.reject(new Error(\r\n                            'Authentication required, but an invalid session was returned'\r\n                        ));\r\n                    }\r\n\r\n                    // Fire request with `session`\r\n                    return this.request(method, path, {\r\n                        ...options,\r\n                        session: session\r\n                    });\r\n                }, (error) => {\r\n                    // No session available\r\n                    return Promise.reject(new Error(\r\n                        'Authentication required, but no session is available (error: ' + error.message + ')'\r\n                    ));\r\n                });\r\n            }\r\n\r\n            // Validate session\r\n            if(!isDefined(options.session.access_token)) {\r\n                return Promise.reject(new Error(\r\n                    'Invalid session provided, expected an object with the \"access_token\" property'\r\n                ));\r\n            }\r\n\r\n            // Set authorization header\r\n            options.headers['Authorization'] = 'Bearer ' + options.session.access_token;\r\n        }\r\n\r\n        // Application metadata\r\n        if(!isDefined(options.application)) {\r\n            options.application = {\r\n                name: 'trakt.js',\r\n                version: this._client.build.version,\r\n                date: this._client.build.date\r\n            };\r\n        }\r\n\r\n        // Application parameters\r\n        if(options.includeAppParameters === true) {\r\n            // Validate request method\r\n            if(method !== 'POST') {\r\n                return Promise.reject(new Error(\r\n                    '\"includeAppParameters\" can only be used with POST requests'\r\n                ));\r\n            }\r\n\r\n            // Version\r\n            if(isDefined(options.application.version)) {\r\n                options.body['app_version'] = options.application.version;\r\n            }\r\n\r\n            // Date\r\n            if(isDefined(options.application.date)) {\r\n                options.body['app_date'] = options.application.date;\r\n            }\r\n        }\r\n\r\n        // User Agent\r\n        options.headers['User-Agent'] = this._buildUserAgent(options.application);\r\n\r\n        // Process body\r\n        if(isDefined(options.body)) {\r\n            // Encode body as `bodyType`\r\n            if(options.bodyType === 'json') {\r\n                options.body = JSON.stringify(options.body);\r\n                options.headers['Content-Type'] = 'application/json';\r\n            } else {\r\n                throw new Error('Invalid \"bodyType\" provided: \"' + options.bodyType + '\"');\r\n            }\r\n        }\r\n\r\n        if(this._client.debug) {\r\n            console.debug('[trakt.js] %s %o (options: %O)', method, path, options);\r\n        }\r\n\r\n        // Send request\r\n        return fetch(this._baseUrl + path + '?' + this.encodeParameters(options.params), {\r\n            method: method,\r\n            headers: options.headers,\r\n            body: options.body\r\n        }).then(function(response) {\r\n            // TODO check status code\r\n            return response.json();\r\n        });\r\n    }\r\n\r\n    encodeParameters(parameters) {\r\n        // Remove undefined parameters\r\n        Object.keys(parameters).forEach((key) => {\r\n            if(typeof parameters[key] === 'undefined') {\r\n                delete parameters[key];\r\n            }\r\n        });\r\n\r\n        // Encode parameters to string\r\n        return querystring.encode(parameters);\r\n    }\r\n\r\n    _buildUserAgent(application) {\r\n        let result = '';\r\n\r\n        // Add application name (or \"Unknown\")\r\n        if(isDefined(application.name)) {\r\n            result += application.name;\r\n        } else {\r\n            result += 'Unknown';\r\n        }\r\n\r\n        // Add fragments (version, date)\r\n        let fragments = [\r\n            application.version,\r\n            application.date\r\n        ].filter((fragment) => {\r\n            return isDefined(fragment);\r\n        });\r\n\r\n        if(fragments.length < 1) {\r\n            return result;\r\n        }\r\n\r\n        return result + ' (' + fragments.join('; ') + ')';\r\n    }\r\n}\r\n"],"sourceRoot":"/source/"}