{"version":3,"sources":["index.js"],"names":["Build","Version","Date","RefreshAt","RefreshDisableAt","fetch","console","error","Promise","Client","key","secret","options","debug","onSessionRefreshed","session","sessionKey","application","name","version","date","build","http","_initialized","_interfaces","_refreshing","resolve","initialize","_constructInterfaces","refresh","then","reject","Error","created_at","expires_in","warn","rem","Math","round","now","abs","_refreshSession","getSession","interfaces","result","value","Object","keys","forEach","prototype","refresh_token","redirect_uri","oauth","stack","fragments","baseUrl","split","names","shift","join"],"mappings":"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","file":"index.js","sourcesContent":["import {isDefined, isFunction, setDefaults} from './core/helpers';\r\nimport HttpClient from './core/http';\r\nimport Interfaces from './interfaces';\r\nimport Interface from './interfaces/base';\r\n\r\nexport const Build = {\r\n    Version: '2.0.0-alpha.2',\r\n    Date: '2016-10-01'\r\n};\r\n\r\nexport const RefreshAt = 7 * 24 * 60 * 60;  // Refresh token one week before expiry\r\nexport const RefreshDisableAt = -28 * 24 * 60 * 60;  // Disable refresh attempts after four weeks\r\n\r\n// Validate environment\r\nif(!isDefined(fetch)) {\r\n    console.error('\"fetch\" is not available, include whatwg-fetch to support this environment');\r\n}\r\n\r\nif(!isDefined(Promise)) {\r\n    console.error('\"Promise\" is not available, include babel-polyfill to support this environment');\r\n}\r\n\r\nexport class Client {\r\n    constructor(key, secret, options) {\r\n        options = setDefaults(options, {\r\n            debug: false,\r\n\r\n            onSessionRefreshed: null,\r\n\r\n            session: null,\r\n            sessionKey: null\r\n        });\r\n\r\n        // Application keys\r\n        this.key = key || null;\r\n        this.secret = secret || null;\r\n\r\n        // Application metadata\r\n        this.application = {\r\n            name: 'trakt.js',\r\n            version: Build.Version,\r\n            date: Build.Date\r\n        };\r\n\r\n        // Build metadata\r\n        this.build = Build;\r\n\r\n        // Session\r\n        this.session = null;\r\n\r\n        if(isDefined(options.session)) {\r\n            this.session = options.session;\r\n        } else if(isDefined(options.sessionKey)) {\r\n            this.session = {key: options.sessionKey};\r\n        }\r\n\r\n        // Callbacks\r\n        this.onSessionRefreshed = options.onSessionRefreshed;\r\n\r\n        // Public variables\r\n        this.debug = options.debug;\r\n        this.http = null;\r\n\r\n        // Private variables\r\n        this._initialized = false;\r\n        this._interfaces = {};\r\n        this._refreshing = Promise.resolve();\r\n\r\n        // Initialize client\r\n        this.initialize();\r\n    }\r\n\r\n    initialize() {\r\n        if(this._initialized) {\r\n            return;\r\n        }\r\n\r\n        // Construct http client\r\n        this.http = new HttpClient(this);\r\n\r\n        // Construct interfaces\r\n        this._interfaces = this._constructInterfaces(Interfaces);\r\n\r\n        // Mark client as initialized\r\n        this._initialized = true;\r\n    }\r\n\r\n    get siteUrl() {\r\n        var fragments = this.http.baseUrl.split('://'),\r\n            names = fragments[1].split('.');\r\n\r\n        // Remove first name ('api' or 'api-v2launch')\r\n        names.shift();\r\n\r\n        return [fragments[0], names.join('.')].join('://');\r\n    }\r\n\r\n    // region Interfaces\r\n\r\n    get users() {\r\n        return this._interfaces['users'];\r\n    }\r\n\r\n    get oauth() {\r\n        return this._interfaces['oauth'];\r\n    }\r\n\r\n    get scrobble() {\r\n        return this._interfaces['scrobble'];\r\n    }\r\n\r\n    get search() {\r\n        return this._interfaces['search'];\r\n    }\r\n\r\n    // endregion\r\n\r\n    // region Public methods\r\n\r\n    getSession(options) {\r\n        options = setDefaults(options, {\r\n            refresh: true\r\n        });\r\n\r\n        return this._refreshing.then(() => {\r\n            var session = this.session;\r\n\r\n            if(!isDefined(session)) {\r\n                return Promise.reject(new Error('No session available'));\r\n            }\r\n\r\n            if(isFunction(session)) {\r\n                session = session();\r\n            }\r\n\r\n            // Resolve session\r\n            return Promise.resolve(session).then((session) => {\r\n                if(!isDefined(session)) {\r\n                    return Promise.reject(new Error('No session available'));\r\n                }\r\n\r\n                if(!isDefined(session.created_at) || !isDefined(session.expires_in)) {\r\n                    console.warn('Missing session expiry properties, unable to determine session validity');\r\n                }\r\n\r\n                // Calculate seconds to/since session expire time\r\n                let rem = Math.round((session.created_at + session.expires_in) - (Date.now() / 1000));\r\n\r\n                if(rem > RefreshAt) {\r\n                    // Ensure the \"onSessionRefreshed\" callback has been defined\r\n                    if(!isDefined(this.onSessionRefreshed)) {\r\n                        console.warn(\r\n                            'onSessionRefreshed callback hasn\\'t been implemented, session will expire in %d second(s)',\r\n                            Math.round(rem)\r\n                        );\r\n                    }\r\n                } else {\r\n                    if(rem < RefreshDisableAt) {\r\n                        // Session has expired, and no `onSessionRefreshed` callback has been defined\r\n                        return Promise.reject(new Error(\r\n                            'Session expired ' + Math.round(Math.abs(rem)) + ' second(s) ago'\r\n                        ));\r\n                    }\r\n\r\n                    if(!isDefined(this.onSessionRefreshed)) {\r\n                        if(rem < 0) {\r\n                            // Session has expired\r\n                            return Promise.reject(new Error(\r\n                                'Session expired ' + Math.round(Math.abs(rem)) + ' second(s) ago'\r\n                            ));\r\n                        }\r\n\r\n                        console.warn('onSessionRefreshed callback hasn\\'t been implemented, unable to refresh session');\r\n                        return session;\r\n                    }\r\n\r\n                    if(rem < 0) {\r\n                        // Session has expired, and no `onSessionRefreshed` callback has been defined\r\n                        console.warn('Session expired ' + Math.round(Math.abs(rem)) + ' second(s) ago');\r\n                    }\r\n\r\n                    if(!options.refresh) {\r\n                        console.warn('Token refresh has been disabled');\r\n                        return session;\r\n                    }\r\n\r\n                    // Refresh authentication token\r\n                    this._refreshing = this._refreshSession(session);\r\n\r\n                    // Wait for token to refresh, then try retrieve the session again\r\n                    return this._refreshing.then(() => {\r\n                        return this.getSession({\r\n                            refresh: false\r\n                        });\r\n                    });\r\n                }\r\n\r\n                // Return current session\r\n                return session;\r\n            });\r\n        });\r\n    }\r\n\r\n    // endregion\r\n\r\n    // region Private methods\r\n\r\n    _constructInterfaces(interfaces) {\r\n        var result = {};\r\n        var value;\r\n\r\n        Object.keys(interfaces).forEach((key) => {\r\n            value = interfaces[key];\r\n\r\n            if(value.prototype instanceof Interface) {\r\n                result[key] = new value(this);  // eslint-disable-line new-cap\r\n            } else {\r\n                result[key] = this._constructInterfaces(value);\r\n            }\r\n        });\r\n\r\n        return result;\r\n    }\r\n\r\n    _refreshSession(session) {\r\n        if(!isDefined(session) || !isDefined(session.refresh_token)) {\r\n            // Unable to refresh session\r\n            return Promise.reject(new Error(\r\n                'Unable to refresh session, no \"refresh_token\" property is available'\r\n            ));\r\n        }\r\n\r\n        if(!isDefined(session.redirect_uri)) {\r\n            console.warn('Session has no \"redirect_uri\" property, defaulting to \"urn:ietf:wg:oauth:2.0:oob\"');\r\n        }\r\n\r\n        if(!isDefined(this.onSessionRefreshed)) {\r\n            return Promise.reject(new Error(\r\n                'Unable to refresh session, onSessionRefreshed callback hasn\\'t been implemented'\r\n            ));\r\n        }\r\n\r\n        // Refresh session\r\n        return this.oauth.refresh(session.refresh_token, session.redirect_uri).then((session) => {\r\n            if(!isDefined(this.onSessionRefreshed)) {\r\n                return;\r\n            }\r\n\r\n            // Fire \"onSessionRefreshed\" callback\r\n            this.onSessionRefreshed(session);\r\n        }, (error) => {\r\n            console.error('Unable to refresh session:', error.stack);\r\n        });\r\n    }\r\n\r\n    // endregion\r\n}\r\n"],"sourceRoot":"/source/"}