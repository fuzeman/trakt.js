!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash-amd/merge"),require("querystring")):"function"==typeof define&&define.amd?define(["lodash-amd/merge","querystring"],t):"object"==typeof exports?exports.trakt=t(require("lodash-amd/merge"),require("querystring")):e.trakt=t(e["lodash-amd/merge"],e.querystring)}(this,function(e,t){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.Client=t.RefreshDisableAt=t.RefreshAt=t.Build=void 0;var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(2),a=n(4),u=r(a),c=n(6),f=r(c),l=n(8),d=r(l),p=t.Build={Version:"2.0.0-alpha.2",Date:"2016-10-01"},h=t.RefreshAt=604800,b=t.RefreshDisableAt=-2419200;(0,s.isDefined)(fetch)||console.error('"fetch" is not available, include whatwg-fetch to support this environment'),(0,s.isDefined)(Promise)||console.error('"Promise" is not available, include babel-polyfill to support this environment');t.Client=function(){function e(t,n,r){i(this,e),r=(0,s.setDefaults)(r,{debug:!1,onSessionRefreshed:null,session:null,sessionKey:null}),this.key=t||null,this.secret=n||null,this.application={name:"trakt.js",version:p.Version,date:p.Date},this.build=p,this.session=null,(0,s.isDefined)(r.session)?this.session=r.session:(0,s.isDefined)(r.sessionKey)&&(this.session={key:r.sessionKey}),this.onSessionRefreshed=r.onSessionRefreshed,this.debug=r.debug,this.http=null,this._initialized=!1,this._interfaces={},this._refreshing=Promise.resolve(),this.initialize()}return o(e,[{key:"initialize",value:function(){this._initialized||(this.http=new u["default"](this),this._interfaces=this._constructInterfaces(f["default"]),this._initialized=!0)}},{key:"getSession",value:function(e){var t=this;return e=(0,s.setDefaults)(e,{refresh:!0}),this._refreshing.then(function(){var n=t.session;return(0,s.isDefined)(n)?((0,s.isFunction)(n)&&(n=n()),Promise.resolve(n).then(function(n){if(!(0,s.isDefined)(n))return Promise.reject(new Error("No session available"));(0,s.isDefined)(n.created_at)&&(0,s.isDefined)(n.expires_in)||console.warn("Missing session expiry properties, unable to determine session validity");var r=Math.round(n.created_at+n.expires_in-Date.now()/1e3);return r>h?((0,s.isDefined)(t.onSessionRefreshed)||console.warn("onSessionRefreshed callback hasn't been implemented, session will expire in %d second(s)",Math.round(r)),n):r<b?Promise.reject(new Error("Session expired "+Math.round(Math.abs(r))+" second(s) ago")):(0,s.isDefined)(t.onSessionRefreshed)?(r<0&&console.warn("Session expired "+Math.round(Math.abs(r))+" second(s) ago"),e.refresh?(t._refreshing=t._refreshSession(n),t._refreshing.then(function(){return t.getSession({refresh:!1})})):(console.warn("Token refresh has been disabled"),n)):r<0?Promise.reject(new Error("Session expired "+Math.round(Math.abs(r))+" second(s) ago")):(console.warn("onSessionRefreshed callback hasn't been implemented, unable to refresh session"),n)})):Promise.reject(new Error("No session available"))})}},{key:"_constructInterfaces",value:function(e){var t,n=this,r={};return Object.keys(e).forEach(function(i){t=e[i],t.prototype instanceof d["default"]?r[i]=new t(n):r[i]=n._constructInterfaces(t)}),r}},{key:"_refreshSession",value:function(e){var t=this;return(0,s.isDefined)(e)&&(0,s.isDefined)(e.refresh_token)?((0,s.isDefined)(e.redirect_uri)||console.warn('Session has no "redirect_uri" property, defaulting to "urn:ietf:wg:oauth:2.0:oob"'),(0,s.isDefined)(this.onSessionRefreshed)?this.oauth.refresh(e.refresh_token,e.redirect_uri).then(function(e){(0,s.isDefined)(t.onSessionRefreshed)&&t.onSessionRefreshed(e)},function(e){console.error("Unable to refresh session:",e.stack)}):Promise.reject(new Error("Unable to refresh session, onSessionRefreshed callback hasn't been implemented"))):Promise.reject(new Error('Unable to refresh session, no "refresh_token" property is available'))}},{key:"siteUrl",get:function(){var e=this.http.baseUrl.split("://"),t=e[1].split(".");return t.shift(),[e[0],t.join(".")].join("://")}},{key:"users",get:function(){return this._interfaces.users}},{key:"oauth",get:function(){return this._interfaces.oauth}},{key:"scrobble",get:function(){return this._interfaces.scrobble}},{key:"search",get:function(){return this._interfaces.search}}]),e}()},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e){return"undefined"!=typeof e&&null!==e}function o(e){return i(e)&&"[object Function]"==={}.toString.call(e)}function s(e){return i(e)&&"[object String]"==={}.toString.call(e)}function a(e,t){return i(e)?(0,c["default"])({},t,e):t}Object.defineProperty(t,"__esModule",{value:!0}),t.isDefined=i,t.isFunction=o,t.isString=s,t.setDefaults=a;var u=n(3),c=r(u)},function(t,n){t.exports=e},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(2),u=n(3),c=r(u),f=n(5),l=r(f),d=function(){function e(t,n){i(this,e),this._client=t,this._baseUrl=n||"https://api.trakt.tv/"}return s(e,[{key:"get",value:function(e,t){return this.request("GET",e,t)}},{key:"post",value:function(e,t){return this.request("POST",e,t)}},{key:"request",value:function(e,t,n){var r=this;if(n=(0,c["default"])({headers:{},params:{},body:null,bodyType:"json",authenticated:!1,session:null,application:null,includeAppParameters:!1},n||{}),(0,a.isDefined)(n.application)||(n.application=this._client.application),n.headers["trakt-api-key"]=this._client.key,n.headers["trakt-api-version"]=2,n.authenticated){if(!(0,a.isDefined)(n.session))return this._client.getSession().then(function(i){return(0,a.isDefined)(i)?r.request(e,t,o({},n,{session:i})):Promise.reject(new Error("Authentication required, but an invalid session was returned"))},function(e){return Promise.reject(new Error("Authentication required, but no session is available (error: "+e.message+")"))});if(!(0,a.isDefined)(n.session.access_token))return Promise.reject(new Error('Invalid session provided, expected an object with the "access_token" property'));n.headers.Authorization="Bearer "+n.session.access_token}if((0,a.isDefined)(n.application)||(n.application={name:"trakt.js",version:this._client.build.version,date:this._client.build.date}),n.includeAppParameters===!0){if("POST"!==e)return Promise.reject(new Error('"includeAppParameters" can only be used with POST requests'));(0,a.isDefined)(n.application.version)&&(n.body.app_version=n.application.version),(0,a.isDefined)(n.application.date)&&(n.body.app_date=n.application.date)}if(n.headers["User-Agent"]=this._buildUserAgent(n.application),(0,a.isDefined)(n.body)){if("json"!==n.bodyType)throw new Error('Invalid "bodyType" provided: "'+n.bodyType+'"');n.body=JSON.stringify(n.body),n.headers["Content-Type"]="application/json"}return this._client.debug&&console.debug("[trakt.js] %s %o (options: %O)",e,t,n),fetch(this._baseUrl+t+"?"+this.encodeParameters(n.params),{method:e,headers:n.headers,body:n.body}).then(function(e){return e.json()})}},{key:"encodeParameters",value:function(e){return Object.keys(e).forEach(function(t){"undefined"==typeof e[t]&&delete e[t]}),l["default"].encode(e)}},{key:"_buildUserAgent",value:function(e){var t="";t+=(0,a.isDefined)(e.name)?e.name:"Unknown";var n=[e.version,e.date].filter(function(e){return(0,a.isDefined)(e)});return n.length<1?t:t+" ("+n.join("; ")+")"}},{key:"baseUrl",get:function(){return this._baseUrl}}]),e}();t["default"]=d,e.exports=t["default"]},function(e,n){e.exports=t},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.SearchInterface=t.ScrobbleInterface=t.OAuthInterface=t.UserSettingsInterface=void 0;var i=n(7),o=r(i),s=n(9),a=r(s),u=n(10),c=r(u),f=n(11),l=r(f);t.UserSettingsInterface=o["default"],t.OAuthInterface=a["default"],t.ScrobbleInterface=c["default"],t.SearchInterface=l["default"],t["default"]={users:{settings:o["default"]},oauth:a["default"],scrobble:c["default"],search:l["default"]}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(8),f=r(c),l=function(e){function t(){return i(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),u(t,[{key:"get",value:function(e){return this.http.get("users/settings",a({},e,{authenticated:!0}))}}]),t}(f["default"]);t["default"]=l,e.exports=t["default"]},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(2),s=function(){function e(t){r(this,e),this._client=(0,o.isDefined)(t)?t:null}return i(e,[{key:"http",get:function(){return(0,o.isDefined)(this._client)?this._client.http:null}}]),e}();t["default"]=s,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(2),f=n(8),l=r(f),d=function(e){function t(){return i(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),u(t,[{key:"authorizeUrl",value:function(e,t){if(!(0,c.isDefined)(this._client.key))throw new Error('Missing required client "key" parameter');return this._client.siteUrl+"oauth/authorize?"+this.http.encodeParameters({client_id:this._client.key,response_type:"code",redirect_uri:(0,c.isDefined)(e)?e:"urn:ietf:wg:oauth:2.0:oob",state:t})}},{key:"exchange",value:function(e,t,n){if(!(0,c.isDefined)(this._client.key))throw new Error('Missing required client "key" parameter');if(!(0,c.isDefined)(this._client.secret))throw new Error('Missing required client "secret" parameter');if(!(0,c.isDefined)(e))throw new Error('Invalid value provided for the "code" parameter');return(0,c.isDefined)(t)||(t="urn:ietf:wg:oauth:2.0:oob"),this.http.post("oauth/token",a({},n,{body:{client_id:this._client.key,client_secret:this._client.secret,code:e,redirect_uri:t,grant_type:"authorization_code"}})).then(function(e){return(0,c.isDefined)(e)?(e.redirect_uri=t,e):e})}},{key:"refresh",value:function(e,t,n){if(!(0,c.isDefined)(this._client.key))throw new Error('Missing required client "key" parameter');if(!(0,c.isDefined)(this._client.secret))throw new Error('Missing required client "secret" parameter');if(!(0,c.isDefined)(e))throw new Error('Invalid value provided for the "code" parameter');return this.http.post("oauth/token",a({},n,{body:{client_id:this._client.key,client_secret:this._client.secret,refresh_token:e,redirect_uri:(0,c.isDefined)(t)?t:"urn:ietf:wg:oauth:2.0:oob",grant_type:"refresh_token"}}))}}]),t}(l["default"]);t["default"]=d,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(8),f=r(c),l=function(e){function t(){return i(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),u(t,[{key:"start",value:function(e,t,n){return this.http.post("scrobble/start",a({},n,{authenticated:!0,includeAppParameters:!0,body:a({},e,{progress:t})}))}},{key:"pause",value:function(e,t,n){return this.http.post("scrobble/pause",a({},n,{authenticated:!0,includeAppParameters:!0,body:a({},e,{progress:t})}))}},{key:"stop",value:function(e,t,n){return this.http.post("scrobble/stop",a({},n,{authenticated:!0,includeAppParameters:!0,body:a({},e,{progress:t})}))}}]),t}(f["default"]);t["default"]=l,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(2),f=n(8),l=r(f),d=function(e){function t(){return i(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),u(t,[{key:"lookup",value:function(e,t,n){if(!(0,c.isDefined)(e))throw new Error('Invalid value provided for the "type" parameter');if(!(0,c.isDefined)(t))throw new Error('Invalid value provided for the "id" parameter');return this.http.get("search",a({},n,{params:{id_type:e,id:t}}))}},{key:"query",value:function(e,t,n,r){if(!(0,c.isDefined)(e))throw new Error('Invalid value provided for the "query" parameter');return this.http.get("search",a({},r,{params:{query:e,type:t,year:n}}))}}]),t}(l["default"]);t["default"]=d,e.exports=t["default"]}])});
//# sourceMappingURL=trakt.min.js.map